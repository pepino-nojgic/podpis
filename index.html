<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vytvo≈ô si sv≈Øj podpis | Media:list</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Arial', 'Helvetica', sans-serif;
        }
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0B64D8 0%, #094ba8 100%);
        }
        #mainApp {
            display: none;
        }
        .logo-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Toast notifikace */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            min-width: 300px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            background: white;
        }
        .toast.success { background: #10b981; color: white; }
        .toast.error { background: #ef4444; color: white; }
        .toast.warning { background: #f59e0b; color: white; }
        .toast.info { background: #3b82f6; color: white; }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Validace */
        .input-valid { border-color: #10b981 !important; background-color: #f0fdf4; }
        .input-invalid { border-color: #ef4444 !important; background-color: #fef2f2; }
        
        /* Photo status */
        .photo-status {
            font-size: 12px;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Historie scrollbar */
        #historyList::-webkit-scrollbar {
            width: 6px;
        }
        #historyList::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #historyList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #historyList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- P≈ôihla≈°ovac√≠ obrazovka -->
    <div id="loginScreen">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="mb-6">
                    <img src="https://cdn.medialist.cz/ml_logo.png" alt="Media:list" class="h-12 mx-auto logo-pulse">
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">üîê Pojƒè si vytvo≈ôit podpis!</h1>
                <p class="text-gray-600">Pro p≈ô√≠stup zadej heslo</p>
            </div>
            
            <form onsubmit="checkPassword(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">P≈ô√≠stupov√© heslo</label>
                    <input 
                        type="password" 
                        id="passwordInput"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        autofocus
                    >
                </div>
                
                <div id="errorMessage" class="hidden">
                    <div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                        ‚ùå Nespr√°vn√© heslo, zkus to znovu
                    </div>
                </div>
                
                <button 
                    type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors"
                >
                    Vstoupit
                </button>
            </form>
            
            <div class="mt-6 text-center text-sm text-gray-500">
                Nev√≠≈° heslo? Zeptej se Pepi N. üòä
            </div>
        </div>
    </div>

    <!-- Hlavn√≠ aplikace -->
    <div id="mainApp" class="bg-gradient-to-br from-blue-50 to-gray-100 min-h-screen">
        <!-- Header s logem -->
        <div class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="https://cdn.medialist.cz/ml_logo.png" alt="Media:list" class="h-8">
                    <div class="border-l border-gray-300 pl-4">
                        <h1 class="text-xl font-bold text-gray-800">Gener√°tor podpis≈Ø</h1>
                        <p class="text-sm text-gray-500">Vytvo≈ô si sv≈Øj profesion√°ln√≠ podpis</p>
                    </div>
                </div>
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                    üö™ Odhl√°sit se
                </button>
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-6">
            <div class="grid lg:grid-cols-5 gap-6">
                <!-- Formul√°≈ô - u≈æ≈°√≠ -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">‚úèÔ∏è Tvoje √∫daje</h2>
                    <p class="text-sm text-gray-500 mb-6">Vypl≈à informace, kter√© se maj√≠ objevit v podpisu</p>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jm√©no *</label>
                                <input type="text" id="firstName" value="Jan" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">P≈ô√≠jmen√≠ *</label>
                                <input type="text" id="lastName" value="Anon"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pozice *</label>
                            <input type="text" id="position" value="Marketing Manager"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefon *</label>
                            <input type="text" id="phone" value="123 456 789"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="777 123 456">
                            <p class="text-xs text-gray-500 mt-1">üí° Pi≈° jen ƒç√≠slo, +420 se p≈ôid√° automaticky</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">E-mail *</label>
                            <input type="email" id="email" value="jan.anon@media-list.cz"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">üí° Vypln√≠ se automaticky</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn profil</label>
                            <input type="text" id="linkedin" value="jananon"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <div class="flex items-center gap-2 mt-2">
                                <input type="checkbox" id="showLinkedIn" checked class="w-4 h-4 text-blue-600 rounded">
                                <label for="showLinkedIn" class="text-xs text-gray-600">Zobrazit LinkedIn</label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üì∏ N√°zev fotky *</label>
                            <input type="text" id="photoFilename" value="Anon"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">üí° Vypln√≠ se automaticky</p>
                            <div id="photoStatus" class="photo-status"></div>
                        </div>

                        <div class="flex items-center gap-3 pt-4 border-t">
                            <input type="checkbox" id="darkMode" class="w-5 h-5 text-blue-600 rounded">
                            <label for="darkMode" class="text-sm font-medium text-gray-700">üëÅÔ∏è N√°hled v dark mode</label>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button id="copyBtn" onclick="copyToClipboard()" 
                            class="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            üìã Kop√≠rovat
                        </button>
                        <button id="downloadBtn" onclick="downloadHTML()"
                            class="flex-1 bg-gray-700 hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                            üíæ St√°hnout
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <button onclick="clearSavedData()"
                            class="w-full bg-red-50 hover:bg-red-100 text-red-600 text-sm font-medium py-2 px-4 rounded-lg transition-colors border border-red-200">
                            üóëÔ∏è Vymazat ulo≈æen√° data
                        </button>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <h3 class="font-semibold text-gray-800 mb-3">‚úÖ Kdo u≈æ zkop√≠roval podpis</h3>
                        <div class="bg-green-50 rounded-lg p-4 mb-3 border border-green-200">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-semibold text-green-800">üìä Celkem zkop√≠rov√°no:</span>
                                <span id="historyCount" class="text-lg font-bold text-green-600">0</span>
                            </div>
                        </div>
                        <div id="historyList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                        <button onclick="updateHistoryDisplay()" class="mt-3 w-full bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs font-medium py-2 px-3 rounded-lg transition-colors">
                            üîÑ Obnovit seznam
                        </button>
                        <p class="mt-2 text-xs text-gray-500 text-center">
                            üí° Pro vymaz√°n√≠ otev≈ôi <a href="https://docs.google.com/spreadsheets" target="_blank" class="text-blue-500 underline">Google Sheet</a>
                        </p>
                    </div>

                    <div class="mt-6 pt-6 border-t">
                        <h3 class="font-semibold text-gray-800 mb-3">üì¶ Hromadn√© vytvo≈ôen√≠</h3>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                            <input type="file" id="csvFile" accept=".csv" onchange="handleCSV(event)" class="hidden">
                            <label for="csvFile" class="cursor-pointer">
                                <div class="text-4xl mb-2">üì§</div>
                                <span class="text-sm text-gray-600">Nahraj CSV soubor</span>
                            </label>
                        </div>
                        <div id="csvResult" class="mt-4"></div>
                    </div>
                </div>

                <!-- N√°hled - ≈°ir≈°√≠ -->
                <div class="lg:col-span-3 bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">üëÅÔ∏è N√°hled</h2>
                    <p class="text-sm text-gray-500 mb-6">Takhle bude tv≈Øj podpis vypadat</p>
                    <div id="preview" class="border-2 rounded-lg p-8 bg-gray-50 border-gray-200"></div>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <h3 class="font-semibold text-blue-900 mb-3">üí° Jak na to?</h3>
                        <div class="space-y-2 text-sm text-blue-800">
                            <p><strong>1.</strong> Vypl≈à sv√© √∫daje v√Ω≈°e</p>
                            <p><strong>2.</strong> Klikni na "Kop√≠rovat"</p>
                            <p><strong>3.</strong> V Gmailu: Nastaven√≠ ‚Üí Podpis ‚Üí vlo≈æ (Ctrl+V)</p>
                            <p><strong>4.</strong> V Outlooku: Soubor ‚Üí Mo≈ænosti ‚Üí Podpisy</p>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-green-50 rounded-lg">
                        <p class="text-sm text-green-800">
                            <strong>üíö Smart:</strong> Data se ukl√°daj√≠ automaticky. Pole s * jsou povinn√°.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Info panel -->
            <div class="mt-6 bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üìö Co je dobr√© vƒõdƒõt</h3>
                <div class="grid md:grid-cols-4 gap-4 text-sm">
                    <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <div class="font-semibold text-gray-700 mb-2">‚úÖ Funguje v≈°ude</div>
                        <ul class="text-gray-600 space-y-1">
                            <li>‚Ä¢ Gmail (web, mobil)</li>
                            <li>‚Ä¢ Apple Mail</li>
                            <li>‚Ä¢ Outlook</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                        <div class="font-semibold text-gray-700 mb-2">üé® Design</div>
                        <ul class="text-gray-600 space-y-1">
                            <li>‚Ä¢ Firemn√≠ barvy</li>
                            <li>‚Ä¢ Arial font</li>
                            <li>‚Ä¢ Tvoje fotka</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                        <div class="font-semibold text-gray-700 mb-2">üöÄ CDN</div>
                        <ul class="text-gray-600 space-y-1">
                            <li>‚Ä¢ Rychl√© naƒç√≠t√°n√≠</li>
                            <li>‚Ä¢ Retina kvalita</li>
                            <li>‚Ä¢ Optimalizovan√©</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                        <div class="font-semibold text-gray-700 mb-2">‚ö° Smart</div>
                        <ul class="text-gray-600 space-y-1">
                            <li>‚Ä¢ Auto-validace</li>
                            <li>‚Ä¢ CDN kontrola</li>
                            <li>‚Ä¢ Auto-ukl√°d√°n√≠</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-6 text-center text-sm text-gray-500">
                <p>Vytvo≈ôeno s ‚ù§Ô∏è pro t√Ωm Media:list</p>
            </div>
        </div>
    </div>

    <script>
        // HESLO
        const CORRECT_PASSWORD = "Podpis.25";
        const SESSION_TIMEOUT = 30 * 60 * 1000;
        
        // GOOGLE SHEETS API
        const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxhzQTGP-aFtwHh8tv7NXfq2rbhBguWLeRRzgeVJk2GmJ7ykxoSv-Qx-U2okB7DsWk1ng/exec";
        
        // ===========================================
        // TOAST
        // ===========================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            toast.innerHTML = `<span style="font-size:20px;">${icons[type]}</span><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ===========================================
        // VALIDACE
        // ===========================================
        function validateAllFields() {
            const fields = ['firstName', 'lastName', 'position', 'phone', 'email', 'photoFilename'];
            let allValid = true;
            
            fields.forEach(id => {
                const field = document.getElementById(id);
                if (!field) return;
                const val = field.value.trim();
                
                // Pr√°zdn√© pole
                if (!val) {
                    field.classList.add('input-invalid');
                    field.classList.remove('input-valid');
                    allValid = false;
                    return;
                }
                
                // Email validace
                if (id === 'email') {
                    if (!val.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                        field.classList.add('input-invalid');
                        field.classList.remove('input-valid');
                        allValid = false;
                    } else {
                        field.classList.add('input-valid');
                        field.classList.remove('input-invalid');
                    }
                    return;
                }
                
                // Telefon validace - D≈ÆLE≈ΩIT√â: pouze ƒç√≠slice bez +420
                if (id === 'phone') {
                    // Extrahuj v≈°echny ƒç√≠slice
                    const allDigits = val.replace(/\D/g, '');
                    
                    // Odstra≈à +420 prefix
                    let cleanDigits = allDigits;
                    if (allDigits.startsWith('420') && allDigits.length > 9) {
                        cleanDigits = allDigits.substring(3);
                    }
                    
                    // Kontrola: p≈ôesnƒõ 9 ƒç√≠slic
                    const isValid = cleanDigits.length === 9 && /^\d{9}$/.test(cleanDigits);
                    
                    if (isValid) {
                        field.classList.add('input-valid');
                        field.classList.remove('input-invalid');
                    } else {
                        field.classList.add('input-invalid');
                        field.classList.remove('input-valid');
                        allValid = false;
                    }
                    return;
                }
                
                // Ostatn√≠ pole - jen nepr√°zdnost
                field.classList.add('input-valid');
                field.classList.remove('input-invalid');
            });
            
            document.getElementById('copyBtn').disabled = !allValid;
            document.getElementById('downloadBtn').disabled = !allValid;
            return allValid;
        }

        // ===========================================
        // CDN KONTROLA
        // ===========================================
        let photoCheckTimeout;
        function checkPhotoExists(filename) {
            if (!filename || !filename.trim()) {
                document.getElementById('photoStatus').innerHTML = '';
                return;
            }
            
            clearTimeout(photoCheckTimeout);
            const status = document.getElementById('photoStatus');
            status.innerHTML = '<div class="spinner"></div> Kontroluji...';
            
            photoCheckTimeout = setTimeout(() => {
                const url = `https://cdn.medialist.cz/profil/ML_1080x1080px_${filename}.png`;
                const img = new Image();
                let timeoutId;
                let completed = false;
                
                // Timeout po 8 sekund√°ch
                timeoutId = setTimeout(() => {
                    if (!completed) {
                        completed = true;
                        status.innerHTML = '<span style="color:#6b7280">üí° Nezapome≈à nahr√°t fotku na CDN</span>';
                    }
                }, 8000);
                
                img.onload = function() {
                    if (completed) return;
                    completed = true;
                    clearTimeout(timeoutId);
                    
                    // Kontrola ≈æe je to skuteƒçn√Ω obr√°zek (ne error page)
                    // naturalWidth a naturalHeight jsou spolehlivƒõj≈°√≠ ne≈æ width/height
                    if (this.naturalWidth > 100 && this.naturalHeight > 100) {
                        status.innerHTML = '<span style="color:#10b981">‚úÖ Fotka nalezena na CDN</span>';
                    } else {
                        status.innerHTML = '<span style="color:#ef4444">‚ö†Ô∏è Fotka nenalezena - nahraj ji na CDN</span>';
                    }
                };
                
                img.onerror = function() {
                    if (completed) return;
                    completed = true;
                    clearTimeout(timeoutId);
                    status.innerHTML = '<span style="color:#ef4444">‚ö†Ô∏è Fotka nenalezena - nahraj ji na CDN</span>';
                };
                
                // Cache busting + ƒçasov√° zn√°mka
                img.src = url + '?v=' + Date.now();
            }, 800);
        }

        // ===========================================
        // LOCALSTORAGE
        // ===========================================
        function saveData() {
            const data = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                position: document.getElementById('position').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                linkedin: document.getElementById('linkedin').value,
                photoFilename: document.getElementById('photoFilename').value,
                showLinkedIn: document.getElementById('showLinkedIn').checked,
                darkMode: document.getElementById('darkMode').checked,
                timestamp: Date.now()
            };
            localStorage.setItem('mlSigData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('mlSigData');
            if (!saved) return false;
            try {
                const data = JSON.parse(saved);
                if (Date.now() - data.timestamp > 7 * 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('mlSigData');
                    return false;
                }
                document.getElementById('firstName').value = data.firstName || 'Jan';
                document.getElementById('lastName').value = data.lastName || 'Anon';
                document.getElementById('position').value = data.position || 'Marketing Manager';
                document.getElementById('phone').value = data.phone || '123 456 789';
                document.getElementById('email').value = data.email || 'jan.anon@media-list.cz';
                document.getElementById('linkedin').value = data.linkedin || 'jananon';
                document.getElementById('photoFilename').value = data.photoFilename || 'Anon';
                document.getElementById('showLinkedIn').checked = data.showLinkedIn !== false;
                document.getElementById('darkMode').checked = data.darkMode || false;
                return true;
            } catch(e) {
                return false;
            }
        }

        function clearSavedData() {
            if(!confirm('Vymazat ulo≈æen√° data?')) return;
            localStorage.removeItem('mlSigData');
            location.reload();
        }

        // ===========================================
        // HELPERS
        // ===========================================
        function removeDiacritics(str) {
            const map = {'√°':'a','ƒç':'c','ƒè':'d','√©':'e','ƒõ':'e','√≠':'i','≈à':'n','√≥':'o','≈ô':'r','≈°':'s','≈•':'t','√∫':'u','≈Ø':'u','√Ω':'y','≈æ':'z','√Å':'A','ƒå':'C','ƒé':'D','√â':'E','ƒö':'E','√ç':'I','≈á':'N','√ì':'O','≈ò':'R','≈†':'S','≈§':'T','√ö':'U','≈Æ':'U','√ù':'Y','≈Ω':'Z'};
            return str.replace(/[^\u0000-\u007E]/g, c => map[c] || c);
        }

        function generateEmail() {
            const first = document.getElementById('firstName').value.trim();
            const last = document.getElementById('lastName').value.trim();
            if(first && last) {
                document.getElementById('email').value = 
                    `${removeDiacritics(first).toLowerCase()}.${removeDiacritics(last).toLowerCase()}@media-list.cz`;
            }
        }

        function generatePhotoFilename() {
            const last = document.getElementById('lastName').value.trim();
            if(last) {
                const clean = removeDiacritics(last);
                document.getElementById('photoFilename').value = clean.charAt(0).toUpperCase() + clean.slice(1).toLowerCase();
            }
        }

        function formatPhone(val) {
            let nums = val.replace(/\D/g, '');
            if(nums.startsWith('420')) nums = nums.substring(3);
            nums = nums.substring(0, 9);
            if(!nums) return '';
            let fmt = '+420';
            if(nums.length > 0) fmt += ' ' + nums.substring(0, 3);
            if(nums.length > 3) fmt += ' ' + nums.substring(3, 6);
            if(nums.length > 6) fmt += ' ' + nums.substring(6, 9);
            return fmt;
        }

        // ===========================================
        // GENER√ÅTOR
        // ===========================================
        function generateSignatureHTML() {
            const data = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                position: document.getElementById('position').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                linkedin: document.getElementById('linkedin').value,
                photoFilename: document.getElementById('photoFilename').value
            };

            // KONSTANTN√ç HODNOTY - nez√°visl√© na checkboxu darkMode
            const showLinkedIn = document.getElementById('showLinkedIn').checked;
            const bgColor = 'transparent';
            const textColor = '#222222';
            const accentColor = '#0B64D8';
            const logoUrl = 'https://cdn.medialist.cz/ml_logo.png';

            const phoneDisplay = formatPhone(data.phone);
            const phoneHref = data.phone.replace(/\D/g, '');

            const linkedInHTML = showLinkedIn && data.linkedin ? `
          <td valign="middle" style="padding:2px 6px 2px 0;">
            <img src="https://cdn.medialist.cz/LinkedIN.png" width="17" height="17" alt="LinkedIn" style="display:block;width:17px;height:17px;border:0;outline:0;-ms-interpolation-mode:bicubic;">
          </td>
          <td valign="middle" style="padding:2px 0 2px 0;">
            <a href="https://www.linkedin.com/in/${data.linkedin}/" style="color:${textColor};text-decoration:none;">linkedin.com/in/${data.linkedin}/</a>
          </td>` : '';

            return `<!-- EMAIL SIGNATURE ¬∑ media:list ¬∑ ${data.firstName} ${data.lastName} -->
<table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;background:${bgColor};font-family:Arial,Helvetica,sans-serif;color:${textColor};">
  <tr>
    <td valign="top" style="padding:0 6px 6px 0;">
      <img src="https://cdn.medialist.cz/profil/ML_1080x1080px_${data.photoFilename}.png" width="105" height="105" alt="${data.firstName} ${data.lastName}" style="display:block;border:0;outline:0;width:105px;height:105px;background:${bgColor};-ms-interpolation-mode:bicubic;">
    </td>
    <td valign="top" style="padding-top:11px;">
      <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;">
        <tr>
          <td style="font-size:17px;line-height:21px;font-weight:700;color:${textColor};padding:0 8px 5px 0;white-space:nowrap;">${data.firstName} ${data.lastName}</td>
          <td style="font-size:17px;line-height:21px;font-weight:700;color:${accentColor};padding:0 0 5px 0;white-space:nowrap;">${data.position}</td>
        </tr>
      </table>
      <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;font-size:11px;line-height:16px;color:${textColor};font-weight:400;mso-line-height-rule:exactly;">
        <tr>
          <td valign="middle" style="padding:2px 6px 2px 0;">
            <img src="https://cdn.medialist.cz/Phone.png" width="17" height="17" alt="Telefon" style="display:block;width:17px;height:17px;border:0;outline:0;-ms-interpolation-mode:bicubic;">
          </td>
          <td valign="middle" style="padding:2px 14px 2px 0;white-space:nowrap;">
            <a href="tel:+420${phoneHref}" style="color:${textColor};text-decoration:none;">${phoneDisplay}</a>
          </td>
          <td valign="middle" style="padding:2px 6px 2px 0;">
            <img src="https://cdn.medialist.cz/Mail.png" width="17" height="17" alt="E-mail" style="display:block;width:17px;height:17px;border:0;outline:0;-ms-interpolation-mode:bicubic;">
          </td>
          <td valign="middle" style="padding:2px 0 2px 0;">
            <a href="mailto:${data.email}" style="color:${textColor};text-decoration:none;">${data.email}</a>
          </td>
        </tr>
      </table>
      <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="1" style="border-collapse:collapse;">
        <tr><td style="line-height:0;font-size:0;height:3px;">&nbsp;</td></tr>
      </table>
      <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;font-size:11px;line-height:16px;color:${textColor};font-weight:400;mso-line-height-rule:exactly;">
        <tr>
          <td valign="middle" style="padding:2px 6px 2px 0;">
            <img src="https://cdn.medialist.cz/web.png" width="17" height="17" alt="Web" style="display:block;width:17px;height:17px;border:0;outline:0;-ms-interpolation-mode:bicubic;">
          </td>
          <td valign="middle" style="padding:2px 14px 2px 0;">
            <a href="https://medialist.cz" style="color:${textColor};text-decoration:none;">medialist.cz</a>
          </td>${linkedInHTML}
        </tr>
      </table>
      <table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;margin-top:5px;">
        <tr>
          <td style="padding:4px 0 0 0;">
            <img src="${logoUrl}" width="98" alt="media:list logo" style="display:block;border:0;outline:0;width:98px;height:auto;background:${bgColor};-ms-interpolation-mode:bicubic;">
          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>`;
        }

        function updatePreview() {
            const html = generateSignatureHTML();
            const isDark = document.getElementById('darkMode').checked;

            // isDark ovliv≈àuje POUZE vizu√°ln√≠ n√°hled v aplikaci, ne generovan√Ω HTML
            document.getElementById('preview').innerHTML = html;
            document.getElementById('preview').className = isDark ?
                'border-2 rounded-lg p-8 bg-gray-900 border-gray-700' :
                'border-2 rounded-lg p-8 bg-gray-50 border-gray-200';
        }

        async function copyToClipboard() {
            if(!validateAllFields()) {
                showToast('Vypl≈à v≈°echna pole spr√°vnƒõ', 'warning');
                return;
            }
            const html = generateSignatureHTML();
            try {
                await navigator.clipboard.write([new ClipboardItem({'text/html': new Blob([html], {type:'text/html'})})]);
                showToast('Podpis zkop√≠rov√°n!', 'success');
                
                // P≈ôidat do historie
                addToHistory();
            } catch(e) {
                const ta = document.createElement('textarea');
                ta.value = html;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast('Podpis zkop√≠rov√°n!', 'success');
                
                // P≈ôidat do historie
                addToHistory();
            }
        }

        function downloadHTML() {
            if(!validateAllFields()) {
                showToast('Vypl≈à v≈°echna pole spr√°vnƒõ', 'warning');
                return;
            }
            const html = generateSignatureHTML();
            const fn = document.getElementById('firstName').value;
            const ln = document.getElementById('lastName').value;
            const blob = new Blob([html], {type:'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `podpis_${fn}_${ln}.html`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Podpis sta≈æen!', 'success');
        }

        function handleCSV(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const text = ev.target.result;
                const lines = text.split('\n').slice(1).filter(l=>l.trim());
                const employees = lines.map(l => {
                    const v = l.split(',').map(x=>x.trim());
                    return {firstName:v[0],lastName:v[1],position:v[2],phone:v[3],email:v[4],linkedin:v[5],photoFilename:v[6]};
                });
                document.getElementById('csvResult').innerHTML = `
                    <p class="text-sm text-green-600 mb-2">‚úì Naƒçteno ${employees.length} lid√≠</p>
                    <button onclick="downloadAllFromCSV()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg">
                        üíæ St√°hnout v≈°echny (${employees.length})
                    </button>
                `;
                window.csvEmployees = employees;
            };
            reader.readAsText(file);
        }

        function downloadAllFromCSV() {
            if(!window.csvEmployees) return;
            window.csvEmployees.forEach(p => {
                document.getElementById('firstName').value = p.firstName;
                document.getElementById('lastName').value = p.lastName;
                document.getElementById('position').value = p.position;
                document.getElementById('phone').value = p.phone;
                document.getElementById('email').value = p.email;
                document.getElementById('linkedin').value = p.linkedin;
                document.getElementById('photoFilename').value = p.photoFilename;
                document.getElementById('showLinkedIn').checked = !!(p.linkedin && p.linkedin.trim());
                const html = generateSignatureHTML();
                const blob = new Blob([html], {type:'text/html'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `podpis_${p.firstName}_${p.lastName}.html`;
                a.click();
                URL.revokeObjectURL(url);
            });
            showToast(`Sta≈æeno ${window.csvEmployees.length} podpis≈Ø!`, 'success');
        }

        // ===========================================
        // P≈òIHL√Å≈†EN√ç
        // ===========================================
        window.addEventListener('load', () => {
            const exp = localStorage.getItem('sessionExpiry');
            if(exp && Date.now() < parseInt(exp)) showApp();
        });

        function checkPassword(e) {
            e.preventDefault();
            const pw = document.getElementById('passwordInput').value;
            if(pw === CORRECT_PASSWORD) {
                localStorage.setItem('sessionExpiry', (Date.now() + SESSION_TIMEOUT).toString());
                showApp();
            } else {
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
                setTimeout(() => document.getElementById('errorMessage').classList.add('hidden'), 3000);
            }
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            const hasData = loadData();
            if(hasData) showToast('Obnovena data', 'info');
            
            // Zobraz historii
            updateHistoryDisplay();
            
            setTimeout(() => {
                generateEmail();
                generatePhotoFilename();
                validateAllFields();
                const pf = document.getElementById('photoFilename').value;
                if(pf) checkPhotoExists(pf);
                updatePreview();
                
                // Event listeners
                ['firstName','lastName','position','phone','email','linkedin','photoFilename'].forEach(id => {
                    const el = document.getElementById(id);
                    if(!el) return;
                    el.addEventListener('input', () => {
                        if(id==='firstName' || id==='lastName') {
                            generateEmail();
                            if(id==='lastName') generatePhotoFilename();
                        }
                        if(id==='photoFilename') checkPhotoExists(el.value);
                        if(id==='phone' && !el.matches(':focus')) el.value = formatPhone(el.value);
                        validateAllFields();
                        saveData();
                        updatePreview();
                    });
                    el.addEventListener('change', () => {
                        validateAllFields();
                        saveData();
                        updatePreview();
                    });
                    if(id==='phone') {
                        el.addEventListener('blur', () => {
                            el.value = formatPhone(el.value);
                            validateAllFields();
                            saveData();
                            updatePreview();
                        });
                    }
                });
                
                // Speci√°ln√≠ handling pro checkboxy (darkMode, showLinkedIn)
                ['darkMode', 'showLinkedIn'].forEach(id => {
                    const el = document.getElementById(id);
                    if(!el) return;
                    el.addEventListener('change', () => {
                        console.log('‚úÖ Checkbox zmƒõnƒõn:', id, el.checked);
                        validateAllFields();
                        saveData();
                        updatePreview();
                    });
                });
            }, 100);
        }

        // ===========================================
        // HISTORIE KOP√çROV√ÅN√ç - GOOGLE SHEETS
        // ===========================================
        async function addToHistory() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const position = document.getElementById('position').value;
            
            const now = new Date();
            const date = now.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const time = now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
            
            try {
                const response = await fetch(SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        firstName: firstName,
                        lastName: lastName,
                        position: position,
                        date: date,
                        time: time
                    })
                });
                
                // Po ulo≈æen√≠ naƒçti aktu√°ln√≠ data
                setTimeout(() => updateHistoryDisplay(), 1000);
                
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ do Sheets:', error);
                showToast('Nepoda≈ôilo se ulo≈æit do historie', 'warning');
            }
        }

        async function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const historyCount = document.getElementById('historyCount');
            
            // Zobraz loading
            historyList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">üì° Naƒç√≠t√°m...</p>';
            
            try {
                const response = await fetch(SHEETS_URL + '?action=get');
                const data = await response.json();
                
                if (!data.success || !data.history || data.history.length === 0) {
                    historyList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Zat√≠m nikdo nezkop√≠roval podpis</p>';
                    historyCount.textContent = '0';
                    return;
                }
                
                const history = data.history;
                historyCount.textContent = history.length;
                
                historyList.innerHTML = history.map((item) => {
                    return `
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 hover:border-green-400 transition-colors">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800 text-sm">
                                    ${item.firstName} ${item.lastName}
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${item.position} ‚Ä¢ ${item.date} ${item.time}
                                </div>
                            </div>
                            <span class="text-green-500 text-lg">‚úì</span>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ historie:', error);
                historyList.innerHTML = '<p class="text-sm text-red-500 text-center py-4">‚ö†Ô∏è Chyba p≈ôi naƒç√≠t√°n√≠ dat</p>';
                historyCount.textContent = '0';
            }
        }
        
        // Automatick√© obnovov√°n√≠ ka≈æd√Ωch 30 sekund
        setInterval(() => {
            if (document.getElementById('mainApp').style.display !== 'none') {
                updateHistoryDisplay();
            }
        }, 30000);

        function logout() {
            localStorage.removeItem('sessionExpiry');
            location.reload();
        }

        setInterval(() => {
            const exp = localStorage.getItem('sessionExpiry');
            if(!exp || Date.now() >= parseInt(exp)) logout();
        }, 60000);
    </script>
</body>
</html>